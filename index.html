<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Comidinha</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        body { 
            font-family: 'Nunito', sans-serif; 
            /* Evita que a tela inteira se mova ao arrastar no celular */
            overscroll-behavior: none;
        }
        .dragging { opacity: 0.5; transform: scale(1.1); }
        .mouth-hover { 
            transform: scale(2.2); /* BOCA ABRE BEM MAIS */
            height: 2rem; /* Aumenta a altura para um efeito melhor */
            background-color: #f87171; 
        }

        /* ESTILOS PARA BOCA FELIZ/TRISTE */
        .mouth-happy {
            height: 1.25rem; /* h-5 */
            border-radius: 0 0 40px 40px; /* Curva para cima (sorriso) */
            transform: translateY(-4px);
        }
        .mouth-sad {
            height: 1.25rem; /* h-5 */
            border-radius: 40px 40px 0 0; /* Curva para baixo (triste) */
            transform: translateY(4px);
        }
    </style>
</head>
<body class="bg-emerald-50 text-gray-800 antialiased">

    <div class="container mx-auto p-4 min-h-screen flex flex-col items-center justify-center">

        <!-- Título e Gerenciamento de Sessão -->
        <header class="text-center mb-4">
            <h1 class="text-4xl md:text-5xl font-black text-[#01b3e4]">Comidinha</h1>
            <p class="text-lg text-[#01b3e4]">Arraste a comida para a boca do amiguinho!</p>
            <div class="mt-4 p-3 bg-cyan-100 border-2 border-cyan-300 rounded-lg">
                <span class="font-bold text-sm text-cyan-800">ID do Participante:</span>
                <code id="participant-id" class="text-sm text-cyan-900 font-mono"></code>
                <button id="new-session-btn" class="ml-2 bg-[#01b3e4] hover:bg-[#009dcc] text-white font-bold py-1 px-3 rounded-lg text-xs">Nova Sessão</button>
            </div>
        </header>

        <!-- Área Principal do Jogo -->
        <main class="w-full max-w-lg bg-white rounded-3xl shadow-lg p-6 flex flex-col items-center">
            <!-- Avatar -->
            <div id="avatar-container" class="relative w-48 h-48 mb-4">
                <div id="avatar" class="w-full h-full bg-orange-200 rounded-full flex items-center justify-center relative overflow-hidden transition-transform duration-500">
                    <!-- Cabelo -->
                    <div class="absolute -top-2 w-[110%] h-1/2">
                        <div class="absolute w-16 h-16 bg-gray-800 rounded-full -top-4 left-1/2 -translate-x-1/2 transform rotate-12"></div>
                        <div class="absolute w-20 h-20 bg-gray-800 rounded-full -top-6 left-1/4 -translate-x-1/2 transform -rotate-12"></div>
                        <div class="absolute w-20 h-20 bg-gray-800 rounded-full -top-6 right-1/4 translate-x-1/2 transform rotate-12"></div>
                    </div>
                    <!-- Olhos -->
                    <div class="flex gap-6 z-10 relative">
                        <div class="w-6 h-6 bg-white rounded-full border-2 border-gray-800 flex items-center justify-center"><div class="w-3 h-3 bg-gray-800 rounded-full"></div></div>
                        <div class="w-6 h-6 bg-white rounded-full border-2 border-gray-800 flex items-center justify-center"><div class="w-3 h-3 bg-gray-800 rounded-full"></div></div>
                    </div>
                    <!-- Boca -->
                    <div id="mouth" class="absolute w-12 h-6 bg-red-500 rounded-full bottom-8 z-10 transition-all duration-300"></div>
                </div>
            </div>
            <!-- Mensagem de feedback -->
            <div id="message" class="h-8 text-center text-xl font-bold text-gray-600 mb-4 transition-opacity duration-300"></div>
            <!-- Seleção de Alimentos -->
            <div id="food-selection" class="w-full grid grid-cols-4 gap-4"></div>
        </main>
        
        <!-- Área de Log de Dados -->
        <section class="w-full max-w-lg mt-6">
            <div class="bg-gray-800 text-white rounded-xl p-4">
                <h2 class="text-lg font-bold mb-2">Log da Sessão Atual (Tempo Real)</h2>
                <pre id="data-log" class="text-xs h-48 overflow-y-auto bg-gray-900 p-2 rounded-md"></pre>
            </div>
        </section>
    </div>

    <!-- Modal de Confirmação -->
    <div id="confirm-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-white rounded-2xl shadow-lg p-6 max-w-sm w-full text-center">
            <h3 class="text-xl font-bold mb-4">Iniciar Nova Sessão?</h3>
            <p class="text-gray-600 mb-6">Isso irá gerar uma nova ID de participante e limpar o log local. Os dados já enviados não serão afetados.</p>
            <div class="flex justify-center gap-4">
                <button id="modal-cancel-btn" class="py-2 px-6 bg-gray-200 hover:bg-gray-300 rounded-lg font-semibold">Cancelar</button>
                <button id="modal-confirm-btn" class="py-2 px-6 bg-[#01b3e4] hover:bg-[#009dcc] text-white rounded-lg font-semibold">Confirmar</button>
            </div>
        </div>
    </div>
    
    <!-- Módulos do Firebase -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // --- CONFIGURAÇÃO DO FIREBASE ---
        // IMPORTANTE: Substitua este objeto pela configuração do seu projeto Firebase.
        const firebaseConfig = {
            apiKey: "SUA_API_KEY",
            authDomain: "SEU_AUTH_DOMAIN",
            projectId: "SEU_PROJECT_ID",
            storageBucket: "SEU_STORAGE_BUCKET",
            messagingSenderId: "SEU_MESSAGING_SENDER_ID",
            appId: "SUA_APP_ID"
        };
        
        try {
            const app = initializeApp(firebaseConfig);
            const db = getFirestore(app);
            console.log("Firebase inicializado com sucesso!");
            initializeGame(db);
        } catch (error) {
            console.error("Erro ao inicializar o Firebase:", error);
        }
        
        function initializeGame(db) {
            const avatar = document.getElementById('avatar');
            const mouth = document.getElementById('mouth');
            const messageEl = document.getElementById('message');
            const foodSelectionEl = document.getElementById('food-selection');
            const dataLogEl = document.getElementById('data-log');
            const participantIdEl = document.getElementById('participant-id');
            const newSessionBtn = document.getElementById('new-session-btn');
            const confirmModal = document.getElementById('confirm-modal');
            const modalConfirmBtn = document.getElementById('modal-confirm-btn');
            const modalCancelBtn = document.getElementById('modal-cancel-btn');

            let sessionDataLog = [];
            let choiceStartTime = null;
            let draggedFoodElement = null;
            let currentParticipantId = null;
            let touchGhostElement = null; 
            let avatarScale = 0.5; // Variável para controlar o tamanho do avatar

            const foods = [
                { id: 'food-apple', name: 'Maçã', type: 'healthy', imageUrl: 'https://i.ibb.co/v6TM7Lqt/Maca-PNG-Transparente-Sem-Fundo.png' },
                { id: 'food-broccoli', name: 'Brócolis', type: 'healthy', imageUrl: 'https://upload.wikimedia.org/wikipedia/commons/thumb/0/03/Broccoli_and_cross_section_edit.jpg/330px-Broccoli_and_cross_section_edit.jpg' },
                { id: 'food-carrot', name: 'Cenoura', type: 'healthy', imageUrl: 'https://i.ibb.co/gF3K9Ggp/png-clipart-carrot-vegetable-fruit-legume-carrot-food-tomato-thumbnail.png' },
                { id: 'food-fish', name: 'Carne', type: 'healthy', imageUrl: 'https://anamariabrogui.com.br/assets/uploads/receitas/fotos/usuario-2024-62804d05b926bdb851bbf674389dad35.jpg' },
                { id: 'food-milk', name: 'Leite', type: 'healthy', imageUrl: 'https://png.pngtree.com/png-vector/20240812/ourlarge/pngtree-glass-of-milk-png-image_13456032.png' },
                { id: 'food-banana', name: 'Banana', type: 'healthy', imageUrl: 'https://png.pngtree.com/png-clipart/20220716/ourmid/pngtree-banana-yellow-fruit-banana-skewers-png-image_5944324.png' } ,
                { id: 'food-water', name: 'Água', type: 'healthy', imageUrl: 'https://i.ibb.co/wNKCzpCT/pngtree-water-bottle-png-image-15868794.png' } ,
                { id: 'food-egg', name: 'Ovo', type: 'healthy', imageUrl: 'https://conteudo.imguol.com.br/c/entretenimento/52/2020/07/06/ovo-1594070430431_v2_1x1.jpg' } ,
                { id: 'food-donut', name: 'Biscoito recheado', type: 'unhealthy', imageUrl: 'https://w7.pngwing.com/pngs/730/458/png-transparent-oreo-biscuits-oreo-cookie-food-biscuits-automotive-tire-thumbnail.png' } ,
                { id: 'food-fries', name: 'Batata Frita', type: 'unhealthy', imageUrl: 'https://www.estadao.com.br/resizer/v2/SHJEVWJAMBLGHNNFD2RA7RFY2U.jpg?quality=80&auth=df613dd547c609c4169132c5964309806cb21d7c5bf4bf50f851a3d5d81854eb&width=720&height=410&smart=true' },
                { id: 'food-pizza', name: 'Pizza', type: 'unhealthy', imageUrl: 'https://swiftbr.vteximg.com.br/arquivos/ids/208740-450-450/618283-pizza-artesanal-calabresa_inn.jpg?v=638870725352100000' } ,
                { id: 'food-soda', name: 'Refrigerante', type: 'unhealthy', imageUrl: 'https://app.cardapiodigital.net/kipasteldaliberdade/1248-large_default/refrigerantes.jpg' } ,
                { id: 'food-cookie', name: 'Biscoito', type: 'unhealthy', imageUrl: 'https://i.ibb.co/0JtLq1F/cookie.png' } ,
                { id: 'food-chocolate', name: 'Chocolate', type: 'unhealthy', imageUrl: 'https://img.freepik.com/psd-gratuitas/uma-deliciosa-barra-de-chocolate-ao-leite-deixe-se-levar-pela-riqueza_632498-24077.jpg?semt=ais_incoming&w=740&q=80' } ,
                { id: 'food-icecream', name: 'Sorvete', type: 'unhealthy', imageUrl: 'https://s2-receitas.glbimg.com/DhvQNwgZdp2vLFkxPhBI16Y1f20=/0x0:1200x675/984x0/smart/filters:strip_icc()/i.s3.glbimg.com/v1/AUTH_1f540e0b94d8437dbbc39d567a1dee68/internal_photos/bs/2024/c/i/DHLFkrTImcMs4NRmRQEA/sorvete-cremoso-sortido.jpg' },
                { id: 'food-burger', name: 'Hambúrguer', type: 'unhealthy', imageUrl: 'https://blog.colombo.com.br/wp-content/uploads/2021/05/hamburguer-artesanal.jpg' }
            ];

            function startNewSession() {
                currentParticipantId = `P-${Date.now()}-${Math.random().toString(36).substring(2, 7)}`;
                participantIdEl.textContent = currentParticipantId;
                sessionDataLog = [];
                mouth.className = "absolute w-12 h-6 bg-red-500 rounded-full bottom-8 z-10 transition-all duration-300"; // Reset mouth
                avatarScale = 0.5; // Define o tamanho inicial
                avatar.style.transform = `scale(${avatarScale})`; // Aplica o tamanho inicial
                updateDataLog();
                refreshFoodSelection();
                confirmModal.classList.add('hidden');
            }

            async function saveDataToFirebase(logEntry) {
                if (!db || !currentParticipantId) return;
                try {
                    const collectionPath = `pesquisa-nutriamigo/${currentParticipantId}/interacoes`;
                    await addDoc(collection(db, collectionPath), logEntry);
                } catch (e) {
                    console.error("Erro ao adicionar documento: ", e);
                }
            }
            
            function shuffleArray(array) {
                for (let i = array.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [array[i], array[j]] = [array[j], array[i]];
                }
            }
            
            function renderFoods(foodsToRender) {
                foodSelectionEl.innerHTML = '';
                foodsToRender.forEach(food => {
                    const foodEl = document.createElement('div');
                    foodEl.className = 'p-2 bg-gray-100 rounded-2xl flex items-center justify-center cursor-grab active:cursor-grabbing transition-transform hover:scale-105';
                    foodEl.draggable = true;
                    foodEl.dataset.type = food.type;
                    foodEl.dataset.name = food.name;
                    foodEl.innerHTML = `<img src="${food.imageUrl}" alt="${food.name}" class="w-20 h-20 object-contain pointer-events-none">`;
                    foodSelectionEl.appendChild(foodEl);
                    foodEl.addEventListener('dragstart', handleDragStart);
                    foodEl.addEventListener('dragend', handleDragEnd);
                    foodEl.addEventListener('touchstart', handleTouchStart, { passive: false });
                });
            }

            function refreshFoodSelection() {
                shuffleArray(foods);
                const healthyFoods = foods.filter(f => f.type === 'healthy').slice(0, 2);
                const unhealthyFoods = foods.filter(f => f.type === 'unhealthy').slice(0, 2);
                const selectedFoods = [...healthyFoods, ...unhealthyFoods];
                shuffleArray(selectedFoods);
                renderFoods(selectedFoods);
            }

            function updateDataLog(lastEvent) {
                if (!lastEvent) { dataLogEl.textContent = 'Aguardando a primeira interação...\n'; return; }
                if (sessionDataLog.length === 1) { dataLogEl.textContent = ''; }
                const eventType = lastEvent.event === 'aceito' ? 'aceito' : 'rejeitado';
                const foodName = lastEvent.foodName;
                const choiceTime = lastEvent.timeToChoose;
                const timestamp = new Date(lastEvent.localTimestamp).toLocaleTimeString('pt-BR');
                const logText = `[${timestamp}] Alimento "${foodName}" foi ${eventType} em ${choiceTime}s.\n`;
                dataLogEl.textContent += logText;
                dataLogEl.scrollTop = dataLogEl.scrollHeight;
            }

            function logEvent(eventType, food, choiceTime) {
                const logEntry = {
                    serverTimestamp: serverTimestamp(),
                    event: eventType,
                    foodName: food.dataset.name,
                    foodType: food.dataset.type,
                    timeToChoose: parseFloat(choiceTime.toFixed(2)),
                };
                const logEntryForDisplay = {...logEntry, localTimestamp: new Date().toISOString()};
                sessionDataLog.push(logEntryForDisplay);
                updateDataLog(logEntryForDisplay);
                saveDataToFirebase(logEntry);
            }
            
            function showMessage(text, isPositive) {
                messageEl.textContent = text;
                messageEl.classList.toggle('text-green-600', isPositive);
                messageEl.classList.toggle('text-red-600', !isPositive);
                messageEl.style.opacity = '1';
                setTimeout(() => { messageEl.style.opacity = '0'; }, 2000);
            }

            function updateAvatar(type) {
                mouth.classList.remove('mouth-happy', 'mouth-sad');
                void avatar.offsetWidth; 
                if (type === 'healthy') {
                    avatarScale = Math.min(2.0, avatarScale + 0.1); // Cresce, com limite de 200%
                    mouth.classList.add('mouth-happy');
                    showMessage("Que delícia!", true);
                } else {
                    avatarScale = Math.max(0.3, avatarScale - 0.1); // Encolhe, com limite de 30%
                    mouth.classList.add('mouth-sad');
                    showMessage("Não me sinto bem...", false);
                }
                avatar.style.transform = `scale(${avatarScale})`; // Aplica o novo tamanho
            }

            // --- Lógica de Arrastar e Soltar ---
            function processSuccessfulDrop(element) {
                if (!element) return;
                const choiceTime = (Date.now() - choiceStartTime) / 1000;
                
                logEvent('aceito', element, choiceTime);
                updateAvatar(element.dataset.type);
                
                element.dataset.dropped = 'true'; // Previne log de 'rejeitado'
                element.style.display = 'none'; // **FIX:** Usar display:none é mais robusto
                
                setTimeout(refreshFoodSelection, 200);
            }

            function handleDragStart(e) {
                draggedFoodElement = e.target.closest('[draggable]');
                draggedFoodElement.classList.add('dragging');
                choiceStartTime = Date.now();
                e.dataTransfer.effectAllowed = 'move';
            }

            function handleDragEnd() {
                if (draggedFoodElement && draggedFoodElement.dataset.dropped !== 'true') {
                    const choiceTime = (Date.now() - choiceStartTime) / 1000;
                    logEvent('rejeitado', draggedFoodElement, choiceTime);
                }
                if (draggedFoodElement) {
                    draggedFoodElement.classList.remove('dragging');
                    delete draggedFoodElement.dataset.dropped;
                }
                draggedFoodElement = null;
            }

            function handleDragOver(e) { e.preventDefault(); mouth.classList.add('mouth-hover'); }
            function handleDragLeave() { mouth.classList.remove('mouth-hover'); }

            function handleDrop(e) {
                e.preventDefault();
                mouth.classList.remove('mouth-hover');
                processSuccessfulDrop(draggedFoodElement);
            }

            function handleTouchStart(e) {
                e.preventDefault();
                draggedFoodElement = e.target.closest('[draggable]');
                if (!draggedFoodElement) return;
                
                choiceStartTime = Date.now();
                const touch = e.touches[0];
                
                touchGhostElement = draggedFoodElement.cloneNode(true);
                touchGhostElement.classList.add('dragging');
                touchGhostElement.style.position = 'absolute';
                touchGhostElement.style.zIndex = '1000';
                touchGhostElement.style.pointerEvents = 'none';
                document.body.appendChild(touchGhostElement);
                
                touchGhostElement.style.left = `${touch.clientX - touchGhostElement.offsetWidth / 2}px`;
                touchGhostElement.style.top = `${touch.clientY - touchGhostElement.offsetHeight / 2}px`;
                
                draggedFoodElement.classList.add('dragging');
            }

            function handleTouchMove(e) {
                e.preventDefault();
                if (!touchGhostElement) return;
                const touch = e.touches[0];
                touchGhostElement.style.left = `${touch.clientX - touchGhostElement.offsetWidth / 2}px`;
                touchGhostElement.style.top = `${touch.clientY - touchGhostElement.offsetHeight / 2}px`;

                const avatarRect = avatar.getBoundingClientRect(); // CORREÇÃO: Usar o avatar como alvo
                if (touch.clientX > avatarRect.left && touch.clientX < avatarRect.right &&
                    touch.clientY > avatarRect.top && touch.clientY < avatarRect.bottom) {
                    mouth.classList.add('mouth-hover');
                } else {
                    mouth.classList.remove('mouth-hover');
                }
            }

            function handleTouchEnd(e) {
                if (!draggedFoodElement || !touchGhostElement) return;

                document.body.removeChild(touchGhostElement);
                touchGhostElement = null;
                draggedFoodElement.classList.remove('dragging');
                
                const touch = e.changedTouches[0];
                const avatarRect = avatar.getBoundingClientRect(); // CORREÇÃO: Usar o avatar como alvo
                
                mouth.classList.remove('mouth-hover'); 

                if (touch.clientX > avatarRect.left && touch.clientX < avatarRect.right &&
                    touch.clientY > avatarRect.top && touch.clientY < avatarRect.bottom) {
                    processSuccessfulDrop(draggedFoodElement);
                } else {
                    const choiceTime = (Date.now() - choiceStartTime) / 1000;
                    logEvent('rejeitado', draggedFoodElement, choiceTime);
                }
                draggedFoodElement = null;
            }

            // CORREÇÃO: Usar o avatar como alvo para o drop
            avatar.addEventListener('dragover', handleDragOver);
            avatar.addEventListener('dragleave', handleDragLeave);
            avatar.addEventListener('drop', handleDrop);
            
            document.addEventListener('touchmove', handleTouchMove, { passive: false });
            document.addEventListener('touchend', handleTouchEnd);
            
            newSessionBtn.addEventListener('click', () => confirmModal.classList.remove('hidden'));
            modalCancelBtn.addEventListener('click', () => confirmModal.classList.add('hidden'));
            modalConfirmBtn.addEventListener('click', startNewSession);

            startNewSession();
        }
    </script>
</body>
</html>

