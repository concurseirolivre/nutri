<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Comidinha</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Nunito', sans-serif; }
        @keyframes happy-bounce {
            0%, 100% { transform: translateY(0) scale(var(--avatar-scale, 1)); }
            50% { transform: translateY(-15px) scale(var(--avatar-scale, 1)); }
        }
        .happy { animation: happy-bounce 0.5s ease-in-out; }
        @keyframes sick-wobble {
            0%, 100% { transform: translateX(0) rotate(0deg) scale(var(--avatar-scale, 1)); }
            25% { transform: translateX(-5px) rotate(-3deg) scale(var(--avatar-scale, 1)); }
            75% { transform: translateX(5px) rotate(3deg) scale(var(--avatar-scale, 1)); }
        }
        .sick { animation: sick-wobble 0.5s ease-in-out; }
        .dragging { opacity: 0.5; transform: scale(1.1); }
        .mouth-hover { transform: scale(1.5); background-color: #f87171; }
    </style>
</head>
<body class="bg-emerald-50 text-gray-800 antialiased">

    <div class="container mx-auto p-4 min-h-screen flex flex-col items-center justify-center">

        <!-- Título e Gerenciamento de Sessão -->
        <header class="text-center mb-4">
            <h1 class="text-4xl md:text-5xl font-black text-emerald-600">Comidinha nand</h1>
            <p class="text-lg text-emerald-500">Arraste a comida para a boca do seu amigo!</p>
            <div class="mt-4 p-3 bg-yellow-200 border-2 border-yellow-400 rounded-lg">
                <span class="font-bold text-sm text-yellow-800">ID do Participante:</span>
                <code id="participant-id" class="text-sm text-yellow-900 font-mono"></code>
                <button id="new-session-btn" class="ml-2 bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-1 px-3 rounded-lg text-xs">Nova Sessão</button>
            </div>
        </header>

        <!-- Área Principal do Jogo -->
        <main class="w-full max-w-lg bg-white rounded-3xl shadow-lg p-6 flex flex-col items-center">
            <!-- Avatar -->
            <div id="avatar-container" class="relative w-48 h-48 mb-4">
                <div id="avatar" class="w-full h-full bg-orange-200 rounded-full flex items-center justify-center transition-transform duration-500 relative overflow-hidden" style="--avatar-scale: 1;">
                    <div class="absolute -top-2 w-[110%] h-1/2">
                        <div class="absolute w-16 h-16 bg-gray-800 rounded-full -top-4 left-1/2 -translate-x-1/2 transform rotate-12"></div>
                        <div class="absolute w-20 h-20 bg-gray-800 rounded-full -top-6 left-1/4 -translate-x-1/2 transform -rotate-12"></div>
                        <div class="absolute w-20 h-20 bg-gray-800 rounded-full -top-6 right-1/4 translate-x-1/2 transform rotate-12"></div>
                    </div>
                    <div class="flex gap-6 z-10 relative">
                        <div class="w-6 h-6 bg-white rounded-full border-2 border-gray-800 flex items-center justify-center"><div class="w-3 h-3 bg-gray-800 rounded-full"></div></div>
                        <div class="w-6 h-6 bg-white rounded-full border-2 border-gray-800 flex items-center justify-center"><div class="w-3 h-3 bg-gray-800 rounded-full"></div></div>
                    </div>
                    <div id="mouth" class="absolute w-12 h-6 bg-red-500 rounded-full bottom-8 z-10 transition-transform duration-300"></div>
                </div>
            </div>
            <!-- Mensagem de feedback -->
            <div id="message" class="h-8 text-center text-xl font-bold text-gray-600 mb-4 transition-opacity duration-300"></div>
            <!-- Seleção de Alimentos -->
            <div id="food-selection" class="w-full grid grid-cols-2 sm:grid-cols-4 gap-4"></div>
        </main>
        
        <!-- Área de Log de Dados -->
        <section class="w-full max-w-lg mt-6">
            <div class="bg-gray-800 text-white rounded-xl p-4">
                <h2 class="text-lg font-bold mb-2">Log da Sessão Atual (Tempo Real)</h2>
                <pre id="data-log" class="text-xs h-48 overflow-y-auto bg-gray-900 p-2 rounded-md"></pre>
            </div>
        </section>
    </div>

    <!-- Modal de Confirmação -->
    <div id="confirm-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-white rounded-2xl shadow-lg p-6 max-w-sm w-full text-center">
            <h3 class="text-xl font-bold mb-4">Iniciar Nova Sessão?</h3>
            <p class="text-gray-600 mb-6">Isso irá gerar uma nova ID de participante e limpar o log local. Os dados já enviados não serão afetados.</p>
            <div class="flex justify-center gap-4">
                <button id="modal-cancel-btn" class="py-2 px-6 bg-gray-200 hover:bg-gray-300 rounded-lg font-semibold">Cancelar</button>
                <button id="modal-confirm-btn" class="py-2 px-6 bg-emerald-500 hover:bg-emerald-600 text-white rounded-lg font-semibold">Confirmar</button>
            </div>
        </div>
    </div>
    
    <!-- Módulos do Firebase -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // --- CONFIGURAÇÃO DO FIREBASE ---
        // IMPORTANTE: Substitua este objeto pela configuração do seu projeto Firebase.
        const firebaseConfig = {
            apiKey: "SUA_API_KEY",
            authDomain: "SEU_AUTH_DOMAIN",
            projectId: "SEU_PROJECT_ID",
            storageBucket: "SEU_STORAGE_BUCKET",
            messagingSenderId: "SEU_MESSAGING_SENDER_ID",
            appId: "SUA_APP_ID"
        };
        
        try {
            const app = initializeApp(firebaseConfig);
            const db = getFirestore(app);
            console.log("Firebase inicializado com sucesso!");
            initializeGame(db);
        } catch (error) {
            console.error("Erro ao inicializar o Firebase:", error);
            alert("Não foi possível conectar ao banco de dados. Verifique a configuração do Firebase no código.");
        }
        
        function initializeGame(db) {
            const avatar = document.getElementById('avatar');
            const mouth = document.getElementById('mouth');
            const messageEl = document.getElementById('message');
            const foodSelectionEl = document.getElementById('food-selection');
            const dataLogEl = document.getElementById('data-log');
            const participantIdEl = document.getElementById('participant-id');
            const newSessionBtn = document.getElementById('new-session-btn');
            const confirmModal = document.getElementById('confirm-modal');
            const modalConfirmBtn = document.getElementById('modal-confirm-btn');
            const modalCancelBtn = document.getElementById('modal-cancel-btn');

            let avatarScale = 1;
            let sessionDataLog = [];
            let choiceStartTime = null;
            let draggedFoodElement = null;
            let currentParticipantId = null;

            // --- LISTA DE ALIMENTOS COM FOTOS REAIS ---
            const foods = [
                { id: 'food-apple', name: 'Maçã', type: 'healthy', imageUrl: 'https://i.ibb.co/v6TM7Lqt/Maca-PNG-Transparente-Sem-Fundo.png' },
                { id: 'food-broccoli', name: 'Brócolis', type: 'healthy', imageUrl: 'https://i.ibb.co/Rpn3136d/Brocolis-png-1024x1024.png' } ,
                { id: 'food-carrot', name: 'Cenoura', type: 'healthy', imageUrl: 'https://i.ibb.co/dKxT9tG/carrot.png' } ,
                { id: 'food-fish', name: 'Peixe', type: 'healthy', imageUrl: 'https://i.ibb.co/pwnqC5B/fish.png' } ,
                { id: 'food-milk', name: 'Leite', type: 'healthy', imageUrl: 'https://i.ibb.co/hM08NTw/milk.png' } ,
                { id: 'food-banana', name: 'Banana', type: 'healthy', imageUrl: 'https://i.ibb.co/Y05bC5p/banana.png' } ,
                { id: 'food-water', name: 'Água', type: 'healthy', imageUrl: 'https://i.ibb.co/WpP5r6d/water.png' } ,
                { id: 'food-egg', name: 'Ovo', type: 'healthy', imageUrl: 'https://i.ibb.co/RSCyvT9/egg.png' } ,
                { id: 'food-donut', name: 'Donut', type: 'unhealthy', imageUrl: 'https://i.ibb.co/4Z5nKz5/donut.png' } ,
                { id: 'food-fries', name: 'Batata Frita', type: 'unhealthy', imageUrl: 'https://i.ibb.co/GHYy2Bv/fries.png' },
                { id: 'food-pizza', name: 'Pizza', type: 'unhealthy', imageUrl: 'https://i.ibb.co/G03v0Vj/pizza.png' } ,
                { id: 'food-soda', name: 'Refrigerante', type: 'unhealthy', imageUrl: 'https://i.ibb.co/Qk42S3g/soda.png' } ,
                { id: 'food-cookie', name: 'Biscoito', type: 'unhealthy', imageUrl: 'https://i.ibb.co/0JtLq1F/cookie.png' } ,
                { id: 'food-chocolate', name: 'Chocolate', type: 'unhealthy', imageUrl: 'https://i.ibb.co/k1K1W9H/chocolate.png' } ,
                { id: 'food-icecream', name: 'Sorvete', type: 'unhealthy', imageUrl: 'https://i.ibb.co/RzFp43j/ice-cream.png' },
                { id: 'food-burger', name: 'Hambúrguer', type: 'unhealthy', imageUrl: 'https://i.ibb.co/6y4nJ08/burger.png' }
            ];

            function startNewSession() {
                currentParticipantId = `P-${Date.now()}-${Math.random().toString(36).substring(2, 7)}`;
                participantIdEl.textContent = currentParticipantId;
                sessionDataLog = [];
                updateDataLog();
                refreshFoodSelection();
                confirmModal.classList.add('hidden');
            }

            async function saveDataToFirebase(logEntry) {
                if (!db || !currentParticipantId) return;
                try {
                    const collectionPath = `pesquisa-nutriamigo/${currentParticipantId}/interacoes`;
                    await addDoc(collection(db, collectionPath), logEntry);
                } catch (e) {
                    console.error("Erro ao adicionar documento: ", e);
                }
            }
            
            function shuffleArray(array) {
                for (let i = array.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [array[i], array[j]] = [array[j], array[i]];
                }
            }
            
            // --- FUNÇÃO DE RENDERIZAÇÃO ATUALIZADA ---
            function renderFoods(foodsToRender) {
                foodSelectionEl.innerHTML = '';
                foodsToRender.forEach(food => {
                    const foodEl = document.createElement('div');
                    foodEl.className = 'p-2 bg-gray-100 rounded-2xl flex items-center justify-center cursor-grab active:cursor-grabbing transition-transform hover:scale-105';
                    foodEl.draggable = true;
                    foodEl.dataset.type = food.type;
                    foodEl.dataset.name = food.name;
                    // Alterado para usar <img> em vez de <span> de emoji
                    foodEl.innerHTML = `<img src="${food.imageUrl}" alt="${food.name}" class="w-16 h-16 sm:w-20 sm:h-20 object-contain pointer-events-none">`;
                    foodSelectionEl.appendChild(foodEl);
                    foodEl.addEventListener('dragstart', handleDragStart);
                    foodEl.addEventListener('dragend', handleDragEnd);
                });
            }

            function refreshFoodSelection() {
                shuffleArray(foods);
                const healthyFoods = foods.filter(f => f.type === 'healthy').slice(0, 2);
                const unhealthyFoods = foods.filter(f => f.type === 'unhealthy').slice(0, 2);
                const selectedFoods = [...healthyFoods, ...unhealthyFoods];
                shuffleArray(selectedFoods);
                renderFoods(selectedFoods);
            }

            function updateDataLog(lastEvent) {
                // Se for o início da sessão, exibe uma mensagem inicial.
                if (!lastEvent) {
                    dataLogEl.textContent = 'Aguardando a primeira interação...\n';
                    return;
                }

                // Limpa a mensagem inicial no primeiro evento real.
                if (sessionDataLog.length === 1) {
                    dataLogEl.textContent = '';
                }

                const eventType = lastEvent.event === 'aceito' ? 'aceito' : 'rejeitado';
                const foodName = lastEvent.foodName;
                const choiceTime = lastEvent.timeToChoose;
                const timestamp = new Date(lastEvent.localTimestamp).toLocaleTimeString('pt-BR');

                const logText = `[${timestamp}] Alimento "${foodName}" foi ${eventType} em ${choiceTime}s.\n`;

                dataLogEl.textContent += logText; // Adiciona a nova linha de texto
                dataLogEl.scrollTop = dataLogEl.scrollHeight; // Rola para o final
            }

            function logEvent(eventType, food, choiceTime) {
                const logEntry = {
                    serverTimestamp: serverTimestamp(),
                    event: eventType,
                    foodName: food.dataset.name,
                    foodType: food.dataset.type,
                    timeToChoose: parseFloat(choiceTime.toFixed(2)),
                };
                // Adiciona o timestamp local para uso imediato na tela
                const logEntryForDisplay = {...logEntry, localTimestamp: new Date().toISOString()};
                sessionDataLog.push(logEntryForDisplay);
                updateDataLog(logEntryForDisplay); // Passa o evento mais recente para ser exibido
                saveDataToFirebase(logEntry); // Salva o evento sem o timestamp local no Firebase
            }
            
            function showMessage(text, isPositive) {
                messageEl.textContent = text;
                messageEl.classList.toggle('text-green-600', isPositive);
                messageEl.classList.toggle('text-red-600', !isPositive);
                messageEl.style.opacity = '1';
                setTimeout(() => { messageEl.style.opacity = '0'; }, 2000);
            }

            function updateAvatar(type) {
                avatar.classList.remove('happy', 'sick');
                void avatar.offsetWidth; 
                if (type === 'healthy') {
                    avatarScale = Math.min(2.0, avatarScale + 0.1);
                    avatar.classList.add('happy');
                    showMessage("Que delícia!", true);
                } else {
                    avatarScale = Math.max(0.5, avatarScale - 0.1);
                    avatar.classList.add('sick');
                    showMessage("Não me sinto bem...", false);
                }
                avatar.style.transform = `scale(${avatarScale})`;
            }

            function handleDragStart(e) {
                draggedFoodElement = e.target.closest('[draggable]');
                draggedFoodElement.classList.add('dragging');
                choiceStartTime = Date.now();
                e.dataTransfer.effectAllowed = 'move';
            }

            function handleDragEnd() {
                if (draggedFoodElement && draggedFoodElement.dataset.dropped !== 'true') {
                    const choiceTime = (Date.now() - choiceStartTime) / 1000;
                    logEvent('rejeitado', draggedFoodElement, choiceTime);
                }
                if (draggedFoodElement) {
                    draggedFoodElement.classList.remove('dragging');
                    delete draggedFoodElement.dataset.dropped;
                }
                draggedFoodElement = null;
            }

            function handleDragOver(e) { e.preventDefault(); mouth.classList.add('mouth-hover'); }
            function handleDragLeave() { mouth.classList.remove('mouth-hover'); }

            function handleDrop(e) {
                e.preventDefault();
                mouth.classList.remove('mouth-hover');
                if (draggedFoodElement) {
                    draggedFoodElement.dataset.dropped = 'true';
                    const choiceTime = (Date.now() - choiceStartTime) / 1000;
                    logEvent('aceito', draggedFoodElement, choiceTime);
                    updateAvatar(draggedFoodElement.dataset.type);
                    draggedFoodElement.style.display = 'none'; // Esconde o elemento
                    setTimeout(refreshFoodSelection, 500);
                }
            }

            mouth.addEventListener('dragover', handleDragOver);
            mouth.addEventListener('dragleave', handleDragLeave);
            mouth.addEventListener('drop', handleDrop);
            
            newSessionBtn.addEventListener('click', () => confirmModal.classList.remove('hidden'));
            modalCancelBtn.addEventListener('click', () => confirmModal.classList.add('hidden'));
            modalConfirmBtn.addEventListener('click', startNewSession);

            startNewSession();
        }
    </script>
</body>
</html>
